#!/usr/bin/env bash
#Installs and configures HAproxy on a Nginx server.

#install HAProxy
apt-get update
apt-get install -y --no-install-recommends software-properties-common
add-apt-repository -y ppa:vbernat/haproxy-2.0
apt-get install -y haproxy=2.0.\*

#enable the HAProxy init script
echo "ENABLED=1" >> /etc/default/haproxy

#HAProxy Configuration: Global
#Selecting tcp as the mode configures HAProxy to perform layer 4 load balancing.
sed -i 's/mode\thttp/mode\ttcp/' /etc/haproxy/haproxy.cfg
sed -i 's/option\thttplog/option\ttcplog/' /etc/haproxy/haproxy.cfg

#HAProxy Configuration: Proxies
#frontend
echo -e "\nfrontend lb-01" >> /etc/haproxy/haproxy.cfg
echo -e "\tbind *:80" >> /etc/haproxy/haproxy.cfg
echo -e "\tdefault_backend web-backend" >> /etc/haproxy/haproxy.cfg

#backend
echo -e "\nbackend web-backend" >> /etc/haproxy/haproxy.cfg
echo -e "\tbalance roundrobin" >> /etc/haproxy/haproxy.cfg
echo -e "\tmode tcp" >> /etc/haproxy/haproxy.cfg
echo -e "\tserver web-01 34.229.161.179:80 check" >> /etc/haproxy/haproxy.cfg
echo -e "\tserver web-02 52.201.180.153:80 check" >> /etc/haproxy/haproxy.cfg

#start HAProxy
service haproxy restart
